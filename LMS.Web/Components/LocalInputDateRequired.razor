@using Microsoft.AspNetCore.Components.Forms
@inherits InputDate<DateTime>

<input @attributes="AdditionalAttributes" 
       class="@CssClass" 
       type="date" 
       value="@CurrentValueAsString" 
       @onchange="EventCallback.Factory.CreateBinder<string>(this, __value => CurrentValueAsString = __value, CurrentValueAsString)" />

@code {
    protected override string FormatValueAsString(DateTime value)
    {
        if (value == DateTime.MinValue || value == default(DateTime))
        {
            return DateTime.Today.ToString("yyyy-MM-dd");
        }
        
        // Format date as YYYY-MM-DD in local time to prevent timezone issues
        return value.ToString("yyyy-MM-dd");
    }

    protected override bool TryParseValueFromString(string? value, out DateTime result, out string? validationErrorMessage)
    {
        if (string.IsNullOrEmpty(value))
        {
            result = DateTime.Today;
            validationErrorMessage = null;
            return true;
        }

        if (DateTime.TryParseExact(value, "yyyy-MM-dd", null, System.Globalization.DateTimeStyles.None, out var parsedDate))
        {
            result = parsedDate;
            validationErrorMessage = null;
            return true;
        }

        result = DateTime.Today;
        validationErrorMessage = "Please enter a valid date.";
        return false;
    }
}