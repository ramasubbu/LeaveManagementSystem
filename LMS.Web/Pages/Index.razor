@page "/"
@using LMS.Web.Models
@using LMS.Web.Services
@inject EmployeeService EmployeeService
@inject EmployeeProjectDetailsService ProjectDetailsService
@inject EmployeeLeaveDetailsService LeaveDetailsService
@inject WorkHoursService WorkHoursService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Leave Management Portal</PageTitle>
<AuthCheck />
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="jumbotron bg-primary text-white p-5 rounded">
                <h1 class="display-4">Welcome to Leave Management Portal</h1>
                <p class="lead">Manage employees, projects, and leave applications efficiently in one centralized system.</p>
                <hr class="my-4 bg-light">
                <p>Get started by exploring the different sections of the portal using the navigation menu.</p>
                <div class="text-end">
                    <button class="btn btn-light btn-sm" @onclick="Logout">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Work Hours Calculation Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clock"></i> Work Hours Calculator
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">
                                    Employee 
                                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2" 
                                            @onclick="RefreshEmployees" 
                                            disabled="@isLoading"
                                            title="Refresh employee list">
                                        @if (isLoading)
                                        {
                                            <span class="spinner-border spinner-border-sm" role="status"></span>
                                        }
                                        else
                                        {
                                            <i class="fas fa-sync-alt"></i>
                                        }
                                    </button>
                                </label>
                                @if (isLoading)
                                {
                                    <select class="form-select" disabled>
                                        <option>Loading employees...</option>
                                    </select>
                                }
                                else
                                {
                                    <select class="form-select" @bind="selectedEmployeeId">
                                        <option value="">Select Employee</option>
                                        @foreach (var employee in employees.Where(e => e.IsActive).OrderBy(e => e.FirstName).ThenBy(e => e.LastName))
                                        {
                                            <option value="@employee.Id">@employee.FullName (@employee.EmployeeCode)</option>
                                        }
                                    </select>
                                }
                                @if (employees.Any())
                                {
                                    <small class="form-text text-muted">
                                        @employees.Count(e => e.IsActive) active employee(s) available
                                        @if (employees.Any(e => !e.IsActive))
                                        {
                                            <span>, @employees.Count(e => !e.IsActive) inactive</span>
                                        }
                                    </small>
                                }
                                else if (!isLoading)
                                {
                                    <small class="form-text text-warning">No employees found. Please add employees first.</small>
                                }
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">Year</label>
                                <select class="form-select" @bind="selectedYear">
                                    @for (int year = DateTime.Now.Year - 2; year <= DateTime.Now.Year + 1; year++)
                                    {
                                        <option value="@year">@year</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">Month</label>
                                <select class="form-select" @bind="selectedMonth">
                                    @for (int month = 1; month <= 12; month++)
                                    {
                                        var monthName = new DateTime(2023, month, 1).ToString("MMMM");
                                        <option value="@month">@monthName</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="mb-3">
                                <label class="form-label">&nbsp;</label>
                                <div>
                                    <button class="btn btn-primary w-100" @onclick="CalculateWorkHours" disabled="@string.IsNullOrEmpty(selectedEmployeeId)">
                                        <i class="fas fa-calculator"></i> Calculate
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    @if (workHoursResult != null)
                    {
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <h6><strong>Work Hours for @GetSelectedEmployeeName() - @workHoursResult.MonthName @workHoursResult.Year</strong></h6>
                                    <div class="row text-center">
                                        <div class="col-md-2">
                                            <div class="card bg-light">
                                                <div class="card-body py-2">
                                                    <h6 class="card-title">Total Days</h6>
                                                    <h4 class="text-primary">@workHoursResult.TotalDaysInMonth</h4>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="card bg-success text-white">
                                                <div class="card-body py-2">
                                                    <h6 class="card-title">Working Days</h6>
                                                    <h4>@workHoursResult.WorkingDays</h4>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="card bg-secondary text-white">
                                                <div class="card-body py-2">
                                                    <h6 class="card-title">Weekends</h6>
                                                    <h4>@workHoursResult.WeekendDays</h4>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="card bg-warning text-white">
                                                <div class="card-body py-2">
                                                    <h6 class="card-title">Holidays</h6>
                                                    <h4>@workHoursResult.HolidayDays</h4>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="card bg-danger text-white">
                                                <div class="card-body py-2">
                                                    <h6 class="card-title">Leave Days</h6>
                                                    <h4>@workHoursResult.LeaveDays</h4>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="card bg-info text-white">
                                                <div class="card-body py-2">
                                                    <h6 class="card-title">Total Work Hours</h6>
                                                    <h4>@workHoursResult.TotalWorkHours</h4>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card bg-info text-white h-100">
                <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">Total Employees</h5>
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                    <h2 class="mb-3">@employeeCount</h2>
                    <div class="mt-auto">
                        <button class="btn btn-light" @onclick="NavigateToEmployees">
                            Manage Employees
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card bg-success text-white h-100">
                <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">Active Projects</h5>
                        <i class="fas fa-project-diagram fa-2x"></i>
                    </div>
                    <h2 class="mb-3">@activeProjectCount</h2>
                    <div class="mt-auto">
                        <button class="btn btn-light" @onclick="NavigateToProjects">
                            Manage Projects
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card bg-warning text-white h-100">
                <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">Pending Leaves</h5>
                        <i class="fas fa-calendar-times fa-2x"></i>
                    </div>
                    <h2 class="mb-3">@pendingLeaveCount</h2>
                    <div class="mt-auto">
                        <button class="btn btn-light" @onclick="NavigateToLeaves">
                            Manage Leaves
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" @onclick="NavigateToAddEmployee">
                            <i class="fas fa-user-plus"></i> Add New Employee
                        </button>
                        <button class="btn btn-success" @onclick="NavigateToAddProject">
                            <i class="fas fa-plus"></i> Assign Project
                        </button>
                        <button class="btn btn-warning" @onclick="NavigateToAddLeave">
                            <i class="fas fa-calendar-plus"></i> Apply for Leave
                        </button>
                        <button class="btn btn-info" @onclick="NavigateToHolidays">
                            <i class="fas fa-calendar-day"></i> Manage Holidays
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">System Features</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check-circle text-success"></i> Employee Management</li>
                        <li><i class="fas fa-check-circle text-success"></i> Project Assignment Tracking</li>
                        <li><i class="fas fa-check-circle text-success"></i> Leave Application Processing</li>
                        <li><i class="fas fa-check-circle text-success"></i> Leave Approval Workflow</li>
                        <li><i class="fas fa-check-circle text-success"></i> Holiday Management</li>
                        <li><i class="fas fa-check-circle text-success"></i> Work Hours Calculation</li>
                        <li><i class="fas fa-check-circle text-success"></i> Search and Filter Options</li>
                        <li><i class="fas fa-check-circle text-success"></i> MongoDB Integration</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private int employeeCount = 0;
    private int activeProjectCount = 0;
    private int pendingLeaveCount = 0;

    private List<Employee> employees = new();
    private string selectedEmployeeId = string.Empty;
    private int selectedYear = DateTime.Now.Year;
    private int selectedMonth = DateTime.Now.Month;
    private WorkHoursCalculation? workHoursResult;
    private bool isLoading = true;

    protected async override Task OnAfterRenderAsync(bool firstRender)
    {
        // Check authentication
        if (firstRender)
        {
            await LoadData();
        }
    }

    private async Task LoadData()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            // Load employees for the dropdown
            employees = await EmployeeService.GetAllAsync();
            
            // Load dashboard data
            employeeCount = employees.Count(e => e.IsActive);

            var activeProjects = await ProjectDetailsService.GetActiveProjectsAsync();
            activeProjectCount = activeProjects.Count;

            var pendingLeaves = await LeaveDetailsService.GetByStatusAsync(LeaveStatus.Pending);
            pendingLeaveCount = pendingLeaves.Count;
        }
        catch (Exception ex)
        {
            // Handle errors silently for dashboard
            employeeCount = 0;
            activeProjectCount = 0;
            pendingLeaveCount = 0;
            employees = new List<Employee>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task CalculateWorkHours()
    {
        if (!string.IsNullOrEmpty(selectedEmployeeId))
        {
            try
            {
                workHoursResult = await WorkHoursService.CalculateWorkHoursAsync(selectedEmployeeId, selectedYear, selectedMonth);
                StateHasChanged();
            }
            catch (Exception ex)
            {
                // Handle error
                workHoursResult = null;
            }
        }
    }

    private string GetSelectedEmployeeName()
    {
        var employee = employees.FirstOrDefault(e => e.Id == selectedEmployeeId);
        return employee != null ? $"{employee.FirstName} {employee.LastName}" : "Unknown Employee";
    }

    private async Task Logout()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("sessionStorage.clear");
            Navigation.NavigateTo("/login", forceLoad: true);
        }
        catch
        {
            Navigation.NavigateTo("/logout", forceLoad: true);
        }
    }

    private void NavigateToEmployees() => Navigation.NavigateTo("/employees");
    private void NavigateToProjects() => Navigation.NavigateTo("/project-details");
    private void NavigateToLeaves() => Navigation.NavigateTo("/leave-details");
    private void NavigateToAddEmployee() => Navigation.NavigateTo("/employees/add");
    private void NavigateToAddProject() => Navigation.NavigateTo("/project-details/add");
    private void NavigateToAddLeave() => Navigation.NavigateTo("/leave-details/add");
    private void NavigateToHolidays() => Navigation.NavigateTo("/holidays");

    private async Task RefreshEmployees()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            employees = await EmployeeService.GetAllAsync();
            employeeCount = employees.Count(e => e.IsActive);
            
            // Clear selection if the previously selected employee is no longer available
            if (!string.IsNullOrEmpty(selectedEmployeeId) && !employees.Any(e => e.Id == selectedEmployeeId))
            {
                selectedEmployeeId = string.Empty;
                workHoursResult = null;
            }
        }
        catch (Exception ex)
        {
            // Handle error silently
            employees = new List<Employee>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}
